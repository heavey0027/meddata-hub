
# 应用核心框架详解

---

## 目录：核心应用架构 (`App.tsx` & `components/`)

*   **1 [应用根组件与路由配置 (App)](#app-root)**
    *   功能：全局路由、权限守卫、响应式布局、动态菜单。
    *   文件：`App.tsx`
*   **2 [登录与注册页 (Login)](#login-page)**
    *   功能：多角色认证、患者注册、调试模式控制。
    *   文件：`components/Login.tsx`

---

## <a id="app-root"></a>1. `App.tsx` (应用根组件 / 路由配置)

### 功能定位
*   **全局路由管理**：作为单页应用 (SPA) 入口，配置 URL 路径与页面组件的映射关系。
*   **统一骨架布局**：定义 `Layout` 组件，包含响应式侧边栏 (Sidebar)、顶部导航栏 (Header) 及主内容区。
*   **权限路由守卫**：通过 `RequireAuth` 实现拦截，确保登录访问及基于角色 (Admin/Doctor/Patient) 的权限控制。
*   **动态菜单渲染**：根据登录用户角色动态生成侧边栏导航项，实现功能隔离。
*   **系统健康监控**：初始化时检查后端 API 状态，标识当前运行模式（DB 连接或 Mock 模式）。

### 内部逻辑
1.  **路由守卫 (RequireAuth)**
    *   **未登录状态**：重定向至 `/login`，并记录当前路径以便登录后回跳。
    *   **权限不足**：若用户角色不在组件允许的 `roles` 数组内，重定向至首页。
    *   **验证通过**：正常渲染受保护的子组件。
2.  **布局与响应式控制 (Layout)**
    *   **侧边栏管理**：维护移动端 (`isMobileMenuOpen`) 与桌面端 (`isDesktopSidebarOpen`) 状态，适配不同屏幕宽度。
    *   **健康检查**：挂载时调用 `checkBackendHealth`，根据反馈在 Header 状态灯显示绿点（成功）或橙点（Mock）。
    *   **登出业务**：调用 `authService.logout` 清除本地持久化数据并执行全页面刷新。
3.  **动态导航构建**
    *   在菜单区域通过条件渲染逻辑，将链接划分为 Admin、Patient、Doctor 及 Debug 四组，确保用户仅可见其权限内的入口。
4.  **路由分发**
    *   采用 `HashRouter` 确保在无服务器端配置的环境下也能正常运行。

### 核心组件与函数

| 名称 | 作用 |
| :--- | :--- |
| `RequireAuth` | 高阶组件 (HOC)，负责路由层面的鉴权与角色校验。 |
| `Layout` | UI 容器，处理全局 UI 状态、侧边栏折叠及后端连接指示。 |
| `SidebarLink` | 封装 NavLink，统一侧边栏导航的交互样式与激活态。 |
| `SystemClock` | 独立时间组件，负责顶部导航栏的实时秒级时间展示。 |

### 数据流
1.  **初始化**：App 加载 -> 路由监听 URL -> 匹配路由。
2.  **鉴权层**：`RequireAuth` 读取 `localStorage` 验证身份。
3.  **环境检查**：`Layout` 发起 `checkBackendHealth` -> 更新 Header 指示灯。
4.  **导航跳转**：用户点击侧边栏 -> URL 变更 -> 渲染对应业务组件。

### 依赖库
*   **react-router-dom**: 核心路由机制及导航守卫。
*   **authService**: 负责用户信息获取及登出处理。
*   **mockDb**: 提供后端连接状态检测接口。
*   **lucide-react**: 提供全站统一的视觉图标。

---

## <a id="login-page"></a>2. `components/Login.tsx` (登录与注册页)

### 功能定位
*   **多角色身份认证**：支持患者、医生、管理员三种身份的一键切换登录。
*   **患者自助注册**：提供注册表单，支持新患者录入信息并自动生成唯一 ID。
*   **路由重定向**：登录后根据角色类型（如医生跳转接诊台，患者跳转预约页）分发路径。
*   **调试状态控制**：内置 Debug 模式开关，控制系统全链路日志的显示与隐藏。

### 业务逻辑
1.  **角色切换逻辑**
    *   通过 `role` 状态管理当前视图。切换时重置错误信息及注册状态，并动态调整表单 Label（如 ID 输入框的提示语）。
2.  **登录流程 (handleLogin)**
    *   调用 `authService.login` 验证。
    *   **成功后处理**：根据角色执行 `navigate` 跳转。注意：执行 `window.location.reload()` 旨在强制触发全局上下文（侧边栏、权限控制）的重新初始化。
3.  **注册流程 (handleRegister)**
    *   仅限 Patient 模式。收集姓名、电话、年龄等字段，调用 `registerPatient`。
    *   **成功反馈**：展示生成的 Patient ID，并自动填充至登录框，引导用户完成首次登录。
4.  **Debug 模式联动**
    *   通过复选框触发 `handleDebugToggle`，将调试偏好持久化至 `localStorage`，影响全局 `logger` 的展示逻辑。

### 核心函数

| 函数名 | 作用 |
| :--- | :--- |
| `handleLogin` | 登录表单提交处理，包含 API 调用、角色跳转路由分发。 |
| `handleRegister` | 患者注册逻辑处理，执行数据封装及注册后的视图引导。 |
| `handleDebugToggle` | 控制全局调试开关的状态变更。 |

### 数据流
1.  **输入**：UI 收集账号凭据或注册档案信息。
2.  **处理**：
    *   组件 State 暂存临时数据。
    *   提交时调用 `authService` 进行鉴权或持久化请求。
3.  **输出**：
    *   **认证成功**：写入 Session -> 路由重定向 -> 应用刷新。
    *   **认证失败**：更新 `error` 状态 -> UI 弹出错误警示。

### 依赖库
*   **react-router-dom**: 用于登录成功后的编程式导航跳转。
*   **authService**: 核心逻辑依赖，处理登录、注册及调试状态。
*   **lucide-react**: 负责角色切换标签及表单中的图标装饰。