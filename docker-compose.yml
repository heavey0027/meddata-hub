version: '3.8'

services:
  # --- 新增 Redis 服务 ---
  redis:
    image: redis:7-alpine
    container_name: meddata-redis
    #在本地通过 Desktop Manager 查看 Redis 数据，暴露端口
    ports:
      - "6379:6379"
    volumes:
      - redis_data:/data
    networks:
      - meddata-net
    restart: always

  # 数据库服务
  db:
    image: mysql:8.0
    container_name: meddata-db
    environment:
      MYSQL_ROOT_PASSWORD: rootpassword  
      MYSQL_DATABASE: meddata_hub
    volumes:
      - db_data:/var/lib/mysql
      # 自动执行初始化 SQL 
      - ./backend/meddata_hub.sql:/docker-entrypoint-initdb.d/init.sql
    networks:
      - meddata-net
    restart: always

  # 后端服务
  backend:
    build: ./backend
    container_name: meddata-api
    depends_on:
      - db
      - redis # 确保 Redis 启动后再启动后端
    environment:
      # MySQL 配置
      DB_HOST: db
      DB_USER: root
      DB_PASSWORD: rootpassword
      DB_NAME: meddata_hub
      
      # 在 Docker 网络内部，直接使用服务名 'redis' 作为主机名
      REDIS_HOST: redis
      REDIS_PORT: 6379
      
      GOOGLE_API_KEY: ${GOOGLE_API_KEY}
    volumes:
      - uploaded_files:/app/uploaded_files  # 将上传的文件存储在卷中
    networks:
      - meddata-net
    restart: always

  # 前端服务
  frontend:
    build:
      context: ./frontend
      dockerfile: Dockerfile
    container_name: meddata-ui
    ports:
      - "1234:80"  # 访问 http://localhost:1234 即可
    depends_on:
      - backend
    networks:
      - meddata-net
    restart: always

volumes:
  db_data:
  redis_data: # 新增 Redis 数据卷
  uploaded_files:

networks:
  meddata-net: